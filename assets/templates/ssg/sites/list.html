{{ define "content" }}
{{ $isAdmin := hasRole .CurrentUserRoles "admin" }}
<div class="card">
    <div class="card-header">
        <h1>Sites</h1>
        {{ if $isAdmin }}<a href="/ssg/new-site" class="btn">New Site</a>{{ end }}
    </div>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Slug</th>
                <th>Active</th>
                {{ if $isAdmin }}<th>Actions</th>{{ end }}
            </tr>
        </thead>
        <tbody>
            {{ range .Sites }}
            <tr class="clickable-row" onclick="localStorage.setItem('currentSiteId', '{{ .ID }}'); window.location='/ssg/get-site?id={{ .ID }}'">
                <td>{{ .Name }}</td>
                <td>{{ .Slug }}</td>
                <td>{{ if .Active }}Yes{{ else }}No{{ end }}</td>
                {{ if $isAdmin }}
                <td>
                    <a href="/ssg/edit-site?id={{ .ID }}" class="btn btn-sm" onclick="event.stopPropagation()">Edit</a>
                    <form method="POST" action="/ssg/delete-site" style="display:inline;" onclick="event.stopPropagation()" onsubmit="if(confirm('Delete site {{ .Name }}? Only database records will be removed. You must delete the filesystem manually.')){if(localStorage.getItem('currentSiteId')==='{{ .ID }}')localStorage.removeItem('currentSiteId');return true;}return false;">
                        <input type="hidden" name="id" value="{{ .ID }}">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </td>
                {{ end }}
            </tr>
            {{ end }}
        </tbody>
    </table>
</div>
<script>
(function() {
    var storedId = localStorage.getItem('currentSiteId');
    if (!storedId) return;
    var validIds = [{{ range .Sites }}'{{ .ID }}',{{ end }}];
    if (validIds.indexOf(storedId) === -1) {
        localStorage.removeItem('currentSiteId');
    }
})();
</script>
{{ end }}
