{{ define "content" }}
<div class="card">
    <p class="breadcrumb"><a href="/ssg/list-contents?site_id={{ .Site.ID }}">‚Üê Contents</a></p>
    <div class="card-header">
        <h1>New Content</h1>
        <div id="save-status" class="save-status">
            <span id="save-indicator" class="htmx-indicator">Saving...</span>
            <span id="save-text"></span>
        </div>
    </div>

    <form id="content-form" method="POST" action="/ssg/create-content"
          hx-post="/ssg/autosave-content"
          hx-trigger="keyup changed delay:500ms, change delay:500ms"
          hx-target="#save-status"
          hx-swap="outerHTML"
          hx-indicator="#save-indicator">
        <input type="hidden" id="content-id" name="id" value="">
        <input type="hidden" name="site_id" value="{{ .Site.ID }}">

        <!-- Basic Fields -->
        <div class="form-group">
            <label for="heading">Title</label>
            <input type="text" id="heading" name="heading" required placeholder="Enter content title">
        </div>

        <!-- Metadata (expanded by default for new content) -->
        <details class="form-details" open>
            <summary>Section, Kind & Summary</summary>
            <div class="form-row">
                <div class="form-group">
                    <label for="section_id">Section</label>
                    <select id="section_id" name="section_id">
                        {{ range .Sections }}
                        <option value="{{ .ID }}">{{ .Name }}</option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-group">
                    <label for="kind">Kind</label>
                    <select id="kind" name="kind" onchange="toggleSeriesFields()">
                        <option value="page">Page</option>
                        <option value="article">Article</option>
                        <option value="blog">Blog</option>
                        <option value="series">Series</option>
                    </select>
                </div>
            </div>

            <div id="series-fields" class="form-row" style="display: none;">
                <div class="form-group">
                    <label for="series">Series Name</label>
                    <input type="text" id="series" name="series" placeholder="Series name">
                </div>

                <div class="form-group">
                    <label for="series_order">Series Order</label>
                    <input type="number" id="series_order" name="series_order" value="0" min="0">
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" name="summary" rows="2" placeholder="Brief summary for listings"></textarea>
            </div>
        </details>

        <!-- Split Pane Editor -->
        <div class="form-group">
            <label>Content (Markdown)</label>
            <div class="editor-toolbar">
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="Italic"><i>I</i></button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt;</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="Link">Link</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('![alt](', ')')" title="Image">Img</button>
                </div>
            </div>
            <div id="editor-wrapper" class="editor-container">
                <div class="editor-pane">
                    <textarea id="body" name="body" class="editor-textarea" placeholder="Write your content in Markdown..."></textarea>
                </div>
                <div class="editor-splitter" id="splitter"></div>
                <div class="editor-pane">
                    <div id="preview" class="editor-preview prose"></div>
                </div>
            </div>
            <small>Images can be uploaded after creating the content.</small>
        </div>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">Tags</label>
            <input type="text" id="tags" name="tags" placeholder="Add tags...">
            <input type="hidden" id="tags-whitelist" value='[{{ range $i, $t := .Tags }}{{ if $i }},{{ end }}{"value":"{{ $t.Name }}","id":"{{ $t.ID }}"}{{ end }}]'>
        </div>

        <!-- Publishing Options -->
        <div class="form-row">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="draft" checked> Draft
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="featured"> Featured
                </label>
            </div>

            <div class="form-group">
                <label for="published_at">Publish Date</label>
                <input type="datetime-local" id="published_at" name="published_at">
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-primary"
                    hx-post="/ssg/autosave-content"
                    hx-include="#content-form"
                    hx-target="#save-status"
                    hx-swap="outerHTML">Save</button>
        </div>
    </form>
</div>

<script src="/static/js/vendor/htmx.min.js"></script>
<script src="/static/js/vendor/marked.min.js"></script>
<script src="/static/js/vendor/tagify.min.js"></script>
<script>
// Elements
const bodyTextarea = document.getElementById('body');
const preview = document.getElementById('preview');
const editorWrapper = document.getElementById('editor-wrapper');
const splitter = document.getElementById('splitter');

// Initialize marked
marked.setOptions({
    breaks: true,
    gfm: true
});

// Update preview on input
function updatePreview() {
    preview.innerHTML = marked.parse(bodyTextarea.value || '');
}

bodyTextarea.addEventListener('input', updatePreview);
updatePreview(); // Initial render

// Toggle series fields based on content kind
function toggleSeriesFields() {
    const kind = document.getElementById('kind').value;
    const seriesFields = document.getElementById('series-fields');
    if (kind === 'series') {
        seriesFields.style.display = '';
    } else {
        seriesFields.style.display = 'none';
    }
}
toggleSeriesFields(); // Initial state

// Splitter drag functionality
let isDragging = false;
let startX, startLeftWidth;

splitter.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    const leftPane = splitter.previousElementSibling;
    startLeftWidth = leftPane.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const leftPane = splitter.previousElementSibling;
    const rightPane = splitter.nextElementSibling;
    const containerWidth = editorWrapper.offsetWidth;
    const newLeftWidth = startLeftWidth + (e.clientX - startX);
    const minWidth = 200;
    const maxWidth = containerWidth - minWidth - splitter.offsetWidth;

    if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
        leftPane.style.flex = 'none';
        leftPane.style.width = newLeftWidth + 'px';
        rightPane.style.flex = '1';
    }
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});

// Toolbar markdown insertion
function insertMarkdown(before, after) {
    const start = bodyTextarea.selectionStart;
    const end = bodyTextarea.selectionEnd;
    const text = bodyTextarea.value;
    const selected = text.substring(start, end);

    bodyTextarea.value = text.substring(0, start) + before + selected + after + text.substring(end);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = start + before.length;
    bodyTextarea.selectionEnd = start + before.length + selected.length;
    updatePreview();
}

// Tagify initialization
(function() {
    const input = document.getElementById('tags');
    if (!input) return;

    const whitelist = JSON.parse(document.getElementById('tags-whitelist').value || '[]');

    new Tagify(input, {
        whitelist: whitelist,
        enforceWhitelist: false,
        dropdown: {
            maxItems: 20,
            enabled: 0,
            closeOnSelect: false
        },
        originalInputValueFormat: valuesArr => valuesArr.map(item => JSON.stringify({value: item.value, id: item.id || ''})).join(',')
    });
})();

// Capture content ID after first autosave
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const saveStatus = document.getElementById('save-status');
    if (saveStatus && saveStatus.dataset.contentId) {
        const contentIdField = document.getElementById('content-id');
        if (contentIdField && !contentIdField.value) {
            contentIdField.value = saveStatus.dataset.contentId;
        }
    }
});

// Update save time display
let lastSaveTime = null;
function updateSaveTimeDisplay() {
    const saveStatus = document.getElementById('save-status');
    if (saveStatus && saveStatus.dataset.savedAt) {
        lastSaveTime = parseInt(saveStatus.dataset.savedAt) * 1000;
    }
    if (lastSaveTime) {
        const seconds = Math.floor((Date.now() - lastSaveTime) / 1000);
        const saveText = document.getElementById('save-text');
        if (saveText) {
            if (seconds < 5) saveText.textContent = 'Saved just now';
            else if (seconds < 60) saveText.textContent = `Saved ${seconds}s ago`;
            else saveText.textContent = `Saved ${Math.floor(seconds/60)}m ago`;
        }
    }
}
setInterval(updateSaveTimeDisplay, 1000);
document.body.addEventListener('htmx:afterSwap', updateSaveTimeDisplay);
</script>
{{ end }}
