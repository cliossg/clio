{{ define "content" }}
<div class="card">
    <p class="breadcrumb"><a href="/ssg/list-contents?site_id={{ .Site.ID }}">← Contents</a></p>
    <div class="card-header">
        <h1>New Content</h1>
        <div id="save-status" class="save-status">
            <span id="save-indicator" class="htmx-indicator">Saving...</span>
            <span id="save-text"></span>
        </div>
    </div>

    <form id="content-form" method="POST" action="/ssg/create-content"
          hx-post="/ssg/autosave-content"
          hx-trigger="keyup changed delay:500ms, change delay:500ms"
          hx-target="#save-status"
          hx-swap="outerHTML"
          hx-indicator="#save-indicator">
        <input type="hidden" id="content-id" name="id" value="">
        <input type="hidden" name="site_id" value="{{ .Site.ID }}">

        <!-- Basic Fields -->
        <div class="form-group">
            <label for="heading">Title</label>
            <input type="text" id="heading" name="heading" required placeholder="Enter content title">
        </div>

        <!-- Header Image Section -->
        <div class="form-group">
            <label>Header Image</label>
            <div id="header-image-container" class="header-image-container">
                <div id="header-image-placeholder" class="header-image-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span id="header-image-text">Save content first to upload header image</span>
                </div>
            </div>
        </div>

        <!-- Split Pane Editor -->
        <div class="form-group">
            <label>Content (Markdown)</label>
            <div class="editor-toolbar">
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="Italic"><i>I</i></button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt;</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="Link">Link</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('![alt](', ')')" title="Image">Img</button>
                </div>
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="toggleZenMode()" title="Zen Mode (Alt+Z)">Zen</button>
                </div>
            </div>
            <div id="editor-wrapper" class="editor-container">
                <div class="editor-pane">
                    <textarea id="body" name="body" class="editor-textarea" placeholder="Write your content in Markdown..."></textarea>
                </div>
                <div class="editor-splitter" id="splitter"></div>
                <div class="editor-pane">
                    <div id="preview" class="editor-preview prose"></div>
                </div>
            </div>
        </div>

        <!-- Content Images Gallery -->
        <div id="images-section" class="form-group" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <label style="margin-bottom: 0;">Content Images <small>(click to insert at cursor)</small></label>
                <button type="button" class="btn btn-secondary btn-sm" onclick="openImageModal('content')">Upload Image</button>
            </div>
            <div id="content-images" class="image-gallery">
                <p class="empty-state">No images yet</p>
            </div>
        </div>

        <!-- Metadata -->
        <details class="form-details">
            <summary>Section, Kind, Contributor & Summary</summary>
            <div class="form-row">
                <div class="form-group">
                    <label for="section_id">Section</label>
                    <select id="section_id" name="section_id">
                        {{ range .Sections }}
                        <option value="{{ .ID }}">{{ .Name }}</option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-group">
                    <label for="kind">Kind</label>
                    <select id="kind" name="kind" onchange="toggleSeriesFields()">
                        <option value="page">Page</option>
                        <option value="article">Article</option>
                        <option value="blog">Blog</option>
                        <option value="series">Series</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contributor_id">Contributor</label>
                    <select id="contributor_id" name="contributor_id">
                        <option value="">— None —</option>
                        {{ range .Contributors }}
                        <option value="{{ .ID }}">{{ .FullName }} (@{{ .Handle }})</option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <div id="series-fields" class="form-row" style="display: none;">
                <div class="form-group">
                    <label for="series">Series Name</label>
                    <input type="text" id="series" name="series" placeholder="Series name">
                </div>

                <div class="form-group">
                    <label for="series_order">Series Order</label>
                    <input type="number" id="series_order" name="series_order" value="0" min="0">
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" name="summary" rows="2" placeholder="Brief summary for listings"></textarea>
            </div>
        </details>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">Tags</label>
            <input type="text" id="tags" name="tags" placeholder="Add tags...">
            <input type="hidden" id="tags-whitelist" value='[{{ range $i, $t := .Tags }}{{ if $i }},{{ end }}{"value":"{{ $t.Name }}","id":"{{ $t.ID }}"}{{ end }}]'>
        </div>

        <!-- Publishing Options -->
        <div class="form-row">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="draft" checked> Draft
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="featured"> Featured
                </label>
            </div>

            <div class="form-group">
                <label for="published_at">Publish Date</label>
                <input type="datetime-local" id="published_at" name="published_at">
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-primary"
                    hx-post="/ssg/autosave-content"
                    hx-include="#content-form"
                    hx-target="#save-status"
                    hx-swap="outerHTML">Save</button>
        </div>
    </form>
</div>

<!-- Floating buttons for Zen Mode -->
<div id="floating-buttons" class="floating-buttons hidden">
    <button type="button" class="floating-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (Alt+D)">Dark</button>
    <button type="button" class="floating-btn" onclick="toggleZenMode()" title="Exit Zen Mode (Alt+Z)">Exit</button>
</div>

<!-- Image Upload Modal -->
<div id="image-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button type="button" class="modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <form id="image-upload-form" enctype="multipart/form-data">
            <input type="hidden" id="image-purpose" name="purpose" value="content">
            <div class="form-group">
                <label for="image-file">Image File</label>
                <div class="file-input-wrapper">
                    <button type="button" class="btn btn-secondary">Choose File</button>
                    <input type="file" id="image-file" name="file" accept="image/*" required>
                </div>
                <small id="file-name-display" style="display: block; margin-top: 0.5rem; color: var(--stone-beige);"></small>
            </div>
            <div class="form-group">
                <label for="image-alt">Alt Text</label>
                <input type="text" id="image-alt" name="alt_text" placeholder="Describe the image">
            </div>
            <div class="form-group">
                <label for="image-title">Title (optional)</label>
                <input type="text" id="image-title" name="title">
            </div>
            <div id="upload-progress" class="upload-progress hidden">
                <div id="upload-progress-bar" class="upload-progress-bar" style="width: 0%"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<script src="/static/js/vendor/htmx.min.js"></script>
<script src="/static/js/vendor/marked.min.js"></script>
<script src="/static/js/vendor/tagify.min.js"></script>
<script>
// Configuration
const siteId = '{{ .Site.ID }}';
const siteSlug = '{{ .Site.Slug }}';
let contentId = '';

// Elements
const bodyTextarea = document.getElementById('body');
const preview = document.getElementById('preview');
const editorWrapper = document.getElementById('editor-wrapper');
const splitter = document.getElementById('splitter');
const floatingButtons = document.getElementById('floating-buttons');

// Initialize marked
marked.setOptions({
    breaks: true,
    gfm: true
});

// Update preview on input
function updatePreview() {
    preview.innerHTML = marked.parse(bodyTextarea.value || '');
}

bodyTextarea.addEventListener('input', updatePreview);
updatePreview(); // Initial render

// Toggle series fields based on content kind
function toggleSeriesFields() {
    const kind = document.getElementById('kind').value;
    const seriesFields = document.getElementById('series-fields');
    if (kind === 'series') {
        seriesFields.style.display = '';
    } else {
        seriesFields.style.display = 'none';
    }
}
toggleSeriesFields(); // Initial state

// Splitter drag functionality
let isDragging = false;
let startX, startLeftWidth;

splitter.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    const leftPane = splitter.previousElementSibling;
    startLeftWidth = leftPane.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const leftPane = splitter.previousElementSibling;
    const rightPane = splitter.nextElementSibling;
    const containerWidth = editorWrapper.offsetWidth;
    const newLeftWidth = startLeftWidth + (e.clientX - startX);
    const minWidth = 200;
    const maxWidth = containerWidth - minWidth - splitter.offsetWidth;

    if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
        leftPane.style.flex = 'none';
        leftPane.style.width = newLeftWidth + 'px';
        rightPane.style.flex = '1';
    }
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});

// Toolbar markdown insertion
function insertMarkdown(before, after) {
    const start = bodyTextarea.selectionStart;
    const end = bodyTextarea.selectionEnd;
    const text = bodyTextarea.value;
    const selected = text.substring(start, end);

    bodyTextarea.value = text.substring(0, start) + before + selected + after + text.substring(end);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = start + before.length;
    bodyTextarea.selectionEnd = start + before.length + selected.length;
    updatePreview();
}

// Insert image at cursor
function insertImageAtCursor(filePath, altText) {
    const imgMarkdown = `![${altText || 'image'}](/ssg/workspace/${siteSlug}/images/${filePath})`;
    const start = bodyTextarea.selectionStart;
    const text = bodyTextarea.value;

    bodyTextarea.value = text.substring(0, start) + imgMarkdown + text.substring(start);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + imgMarkdown.length;
    updatePreview();
}

// Zen Mode
function toggleZenMode() {
    document.body.classList.toggle('zen-mode-active');
    floatingButtons.classList.toggle('hidden');
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    if (e.altKey && key === 'z') {
        e.preventDefault();
        toggleZenMode();
    }
    if (e.altKey && key === 'd' && document.body.classList.contains('zen-mode-active')) {
        e.preventDefault();
        toggleDarkMode();
    }
    if (e.key === 'Escape' && document.body.classList.contains('zen-mode-active')) {
        toggleZenMode();
    }
});

// Image Modal
function openImageModal(purpose) {
    if (!contentId) {
        alert('Please save the content first before uploading images.');
        return;
    }
    document.getElementById('image-purpose').value = purpose;
    document.getElementById('image-modal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('image-upload-form').reset();
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('file-name-display').textContent = '';
}

// Display selected file name
document.getElementById('image-file').addEventListener('change', function(e) {
    const fileNameDisplay = document.getElementById('file-name-display');
    if (this.files.length > 0) {
        fileNameDisplay.textContent = this.files[0].name;
    } else {
        fileNameDisplay.textContent = '';
    }
});

// Image Upload
document.getElementById('image-upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const progressBar = document.getElementById('upload-progress');
    const progressBarInner = document.getElementById('upload-progress-bar');

    progressBar.classList.remove('hidden');
    progressBarInner.style.width = '0%';

    try {
        const response = await fetch(`/ssg/upload-content-image?content_id=${contentId}&site_id=${siteId}`, {
            method: 'POST',
            body: formData
        });

        progressBarInner.style.width = '100%';

        if (response.ok) {
            closeImageModal();
            window.location.reload();
        } else {
            alert('Upload failed. Please try again.');
        }
    } catch (err) {
        alert('Upload error: ' + err.message);
    }
});

// Enable image uploads once content is saved
function enableImageUploads() {
    document.getElementById('images-section').style.display = '';
    const placeholder = document.getElementById('header-image-placeholder');
    if (placeholder) {
        placeholder.onclick = function() { openImageModal('header'); };
        document.getElementById('header-image-text').textContent = 'Click to add header image';
    }
}

// Tagify initialization
(function() {
    const input = document.getElementById('tags');
    if (!input) return;

    const whitelist = JSON.parse(document.getElementById('tags-whitelist').value || '[]');

    new Tagify(input, {
        whitelist: whitelist,
        enforceWhitelist: false,
        dropdown: {
            maxItems: 20,
            enabled: 0,
            closeOnSelect: false
        },
        originalInputValueFormat: valuesArr => valuesArr.map(item => JSON.stringify({value: item.value, id: item.id || ''})).join(',')
    });
})();

// Capture content ID after first autosave and enable image uploads
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const saveStatus = document.getElementById('save-status');
    if (saveStatus && saveStatus.dataset.contentId) {
        const contentIdField = document.getElementById('content-id');
        if (contentIdField && !contentIdField.value) {
            contentIdField.value = saveStatus.dataset.contentId;
        }
        contentId = saveStatus.dataset.contentId;
        enableImageUploads();
    }
});

// Update save time display
let lastSaveTime = null;
function updateSaveTimeDisplay() {
    const saveStatus = document.getElementById('save-status');
    if (saveStatus && saveStatus.dataset.savedAt) {
        lastSaveTime = parseInt(saveStatus.dataset.savedAt) * 1000;
    }
    if (lastSaveTime) {
        const seconds = Math.floor((Date.now() - lastSaveTime) / 1000);
        const saveText = document.getElementById('save-text');
        if (saveText) {
            if (seconds < 5) saveText.textContent = 'Saved just now';
            else if (seconds < 60) saveText.textContent = `Saved ${seconds}s ago`;
            else saveText.textContent = `Saved ${Math.floor(seconds/60)}m ago`;
        }
    }
}
setInterval(updateSaveTimeDisplay, 1000);
document.body.addEventListener('htmx:afterSwap', updateSaveTimeDisplay);

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Close modal on overlay click
document.getElementById('image-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});
</script>
{{ end }}
