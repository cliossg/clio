{{ define "content" }}
<div class="card">
    <div class="card-header">
        <h1>Edit Content</h1>
        <span id="save-status" class="save-status"></span>
    </div>

    {{ if .Error }}
    <div class="alert alert-error">{{ .Error }}</div>
    {{ end }}

    <form id="content-form" method="POST" action="/ssg/update-content">
        <input type="hidden" name="id" value="{{ .Content.ID }}">

        <!-- Basic Fields -->
        <div class="form-group">
            <label for="heading">Title</label>
            <input type="text" id="heading" name="heading" value="{{ .Content.Heading }}" required>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="section_id">Section</label>
                <select id="section_id" name="section_id">
                    <option value="">-- No Section --</option>
                    {{ range .Sections }}
                    <option value="{{ .ID }}" {{ if eq .ID $.Content.SectionID }}selected{{ end }}>{{ .Name }}</option>
                    {{ end }}
                </select>
            </div>

            <div class="form-group">
                <label for="kind">Kind</label>
                <select id="kind" name="kind">
                    <option value="post" {{ if eq .Content.Kind "post" }}selected{{ end }}>Post</option>
                    <option value="page" {{ if eq .Content.Kind "page" }}selected{{ end }}>Page</option>
                    <option value="series" {{ if eq .Content.Kind "series" }}selected{{ end }}>Series</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="series">Series Name</label>
                <input type="text" id="series" name="series" value="{{ .Content.Series }}">
            </div>

            <div class="form-group">
                <label for="series_order">Series Order</label>
                <input type="number" id="series_order" name="series_order" value="{{ .Content.SeriesOrder }}" min="0">
            </div>
        </div>

        <div class="form-group">
            <label for="summary">Summary</label>
            <textarea id="summary" name="summary" rows="2">{{ .Content.Summary }}</textarea>
        </div>

        <!-- Header Image Section -->
        <div class="form-group">
            <label>Header Image</label>
            <div id="header-image-container" class="header-image-container">
                {{ if .HeaderImage }}
                <img src="/ssg/workspace/{{ .Site.Slug }}/images/{{ .HeaderImage.FilePath }}" alt="{{ .HeaderImage.AltText }}">
                <button type="button" class="delete-btn" onclick="removeHeaderImage()" title="Remove header image">&times;</button>
                {{ else }}
                <div class="header-image-placeholder" onclick="openImageModal('header')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Click to add header image</span>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Split Pane Editor -->
        <div class="form-group">
            <label>Content (Markdown)</label>
            <div class="editor-toolbar">
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="Italic"><i>I</i></button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt;</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="Link">Link</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('![alt](', ')')" title="Image">Img</button>
                </div>
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="toggleZenMode()" title="Zen Mode (Alt+Z)">Zen</button>
                </div>
            </div>
            <div id="editor-wrapper" class="editor-container">
                <div class="editor-pane">
                    <textarea id="body" name="body" class="editor-textarea">{{ .Content.Body }}</textarea>
                </div>
                <div class="editor-splitter" id="splitter"></div>
                <div class="editor-pane">
                    <div id="preview" class="editor-preview prose"></div>
                </div>
            </div>
        </div>

        <!-- Content Images Gallery -->
        <div class="form-group">
            <label>Content Images <small>(click to insert at cursor)</small></label>
            <div id="content-images" class="image-gallery">
                {{ range .ContentImages }}
                <div class="gallery-image" onclick="insertImageAtCursor('{{ .FilePath }}', '{{ .AltText }}')" title="{{ .AltText }}">
                    <img src="/ssg/workspace/{{ $.Site.Slug }}/images/{{ .FilePath }}" alt="{{ .AltText }}">
                    <button type="button" class="delete-btn" onclick="event.stopPropagation(); deleteContentImage('{{ .ID }}')" title="Delete">&times;</button>
                    <div class="overlay">{{ .AltText }}</div>
                </div>
                {{ else }}
                <p class="empty-state">No images yet</p>
                {{ end }}
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="openImageModal('content')" style="margin-top: 0.5rem;">Upload Image</button>
        </div>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">Tags</label>
            <input type="text" id="tags" name="tags" value="{{ range $i, $t := .Content.Tags }}{{ if $i }}, {{ end }}{{ $t.Name }}{{ end }}" placeholder="Comma-separated tags">
        </div>

        <!-- Publishing Options -->
        <div class="form-row">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="draft" {{ if .Content.Draft }}checked{{ end }}> Draft
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="featured" {{ if .Content.Featured }}checked{{ end }}> Featured
                </label>
            </div>

            <div class="form-group">
                <label for="published_at">Publish Date</label>
                <input type="datetime-local" id="published_at" name="published_at" {{ if .Content.PublishedAt }}value="{{ .Content.PublishedAt.Format "2006-01-02T15:04" }}"{{ end }}>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Update Content</button>
            <a href="/ssg/get-content?id={{ .Content.ID }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Floating buttons for Zen Mode -->
<div id="floating-buttons" class="floating-buttons hidden">
    <button type="button" class="floating-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (Alt+D)">Dark</button>
    <button type="button" class="floating-btn" onclick="toggleZenMode()" title="Exit Zen Mode (Alt+Z)">Exit</button>
</div>

<!-- Image Upload Modal -->
<div id="image-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button type="button" class="modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <form id="image-upload-form" enctype="multipart/form-data">
            <input type="hidden" id="image-purpose" name="purpose" value="content">
            <div class="form-group">
                <label for="image-file">Image File</label>
                <input type="file" id="image-file" name="file" accept="image/*" required>
            </div>
            <div class="form-group">
                <label for="image-alt">Alt Text</label>
                <input type="text" id="image-alt" name="alt_text" placeholder="Describe the image">
            </div>
            <div class="form-group">
                <label for="image-caption">Caption (optional)</label>
                <input type="text" id="image-caption" name="caption">
            </div>
            <div id="upload-progress" class="upload-progress hidden">
                <div id="upload-progress-bar" class="upload-progress-bar" style="width: 0%"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<script src="/static/js/vendor/marked.min.js"></script>
<script>
// Configuration
const siteId = '{{ .Site.ID }}';
const contentId = '{{ .Content.ID }}';
const siteSlug = '{{ .Site.Slug }}';

// Elements
const bodyTextarea = document.getElementById('body');
const preview = document.getElementById('preview');
const editorWrapper = document.getElementById('editor-wrapper');
const splitter = document.getElementById('splitter');
const floatingButtons = document.getElementById('floating-buttons');

// Initialize marked
marked.setOptions({
    breaks: true,
    gfm: true
});

// Update preview on input
function updatePreview() {
    preview.innerHTML = marked.parse(bodyTextarea.value || '');
}

bodyTextarea.addEventListener('input', updatePreview);
updatePreview(); // Initial render

// Splitter drag functionality
let isDragging = false;
let startX, startLeftWidth;

splitter.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    const leftPane = splitter.previousElementSibling;
    startLeftWidth = leftPane.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const leftPane = splitter.previousElementSibling;
    const rightPane = splitter.nextElementSibling;
    const containerWidth = editorWrapper.offsetWidth;
    const newLeftWidth = startLeftWidth + (e.clientX - startX);
    const minWidth = 200;
    const maxWidth = containerWidth - minWidth - splitter.offsetWidth;

    if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
        leftPane.style.flex = 'none';
        leftPane.style.width = newLeftWidth + 'px';
        rightPane.style.flex = '1';
    }
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});

// Toolbar markdown insertion
function insertMarkdown(before, after) {
    const start = bodyTextarea.selectionStart;
    const end = bodyTextarea.selectionEnd;
    const text = bodyTextarea.value;
    const selected = text.substring(start, end);

    bodyTextarea.value = text.substring(0, start) + before + selected + after + text.substring(end);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = start + before.length;
    bodyTextarea.selectionEnd = start + before.length + selected.length;
    updatePreview();
}

// Insert image at cursor
function insertImageAtCursor(filePath, altText) {
    const imgMarkdown = `![${altText || 'image'}](/ssg/workspace/${siteSlug}/images/${filePath})`;
    const start = bodyTextarea.selectionStart;
    const text = bodyTextarea.value;

    bodyTextarea.value = text.substring(0, start) + imgMarkdown + text.substring(start);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + imgMarkdown.length;
    updatePreview();
}

// Zen Mode
function toggleZenMode() {
    document.body.classList.toggle('zen-mode');
    editorWrapper.classList.toggle('editor-fullscreen');
    floatingButtons.classList.toggle('hidden');
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.altKey && e.key === 'z') {
        e.preventDefault();
        toggleZenMode();
    }
    if (e.altKey && e.key === 'd' && document.body.classList.contains('zen-mode')) {
        e.preventDefault();
        toggleDarkMode();
    }
});

// Image Modal
function openImageModal(purpose) {
    document.getElementById('image-purpose').value = purpose;
    document.getElementById('image-modal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('image-upload-form').reset();
    document.getElementById('upload-progress').classList.add('hidden');
}

// Image Upload (placeholder - requires handler implementation)
document.getElementById('image-upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const progressBar = document.getElementById('upload-progress');
    const progressBarInner = document.getElementById('upload-progress-bar');

    progressBar.classList.remove('hidden');
    progressBarInner.style.width = '0%';

    try {
        const response = await fetch(`/ssg/upload-content-image?content_id=${contentId}`, {
            method: 'POST',
            body: formData
        });

        progressBarInner.style.width = '100%';

        if (response.ok) {
            closeImageModal();
            // Reload page to show new image
            window.location.reload();
        } else {
            alert('Upload failed. Please try again.');
        }
    } catch (err) {
        alert('Upload error: ' + err.message);
    }
});

// Delete content image (placeholder - requires handler implementation)
async function deleteContentImage(imageId) {
    if (!confirm('Delete this image?')) return;

    try {
        const response = await fetch(`/ssg/delete-content-image?id=${imageId}`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Delete failed. Please try again.');
        }
    } catch (err) {
        alert('Delete error: ' + err.message);
    }
}

// Remove header image (placeholder - requires handler implementation)
async function removeHeaderImage() {
    if (!confirm('Remove header image?')) return;

    try {
        const response = await fetch(`/ssg/remove-header-image?content_id=${contentId}`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Remove failed. Please try again.');
        }
    } catch (err) {
        alert('Remove error: ' + err.message);
    }
}
</script>
{{ end }}
