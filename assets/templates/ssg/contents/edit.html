{{ define "content" }}
<div class="card">
    <p class="breadcrumb"><a href="/ssg/list-contents?site_id={{ .Site.ID }}">← Content</a></p>
    <div class="card-header">
        <h1>Edit Content</h1>
        <div id="save-status" class="save-status">
            <span id="save-indicator" class="htmx-indicator">Saving...</span>
            <span id="save-text"></span>
        </div>
    </div>

    <form id="content-form" method="POST" action="/ssg/update-content"
          hx-post="/ssg/autosave-content"
          hx-trigger="keyup changed delay:500ms, change delay:500ms, every 30s"
          hx-target="#save-status"
          hx-swap="outerHTML"
          hx-indicator="#save-indicator">
        <input type="hidden" name="id" value="{{ .Content.ID }}">
        <input type="hidden" name="site_id" value="{{ .Site.ID }}">

        <!-- Basic Fields -->
        <div class="form-group">
            <label for="heading">Title</label>
            <input type="text" id="heading" name="heading" value="{{ .Content.Heading }}" required>
        </div>

        <!-- Header Image Section -->
        <div class="form-group">
            <div class="form-group-header">
                <label>Header Image</label>
                <label class="switch-label discrete" title="Select based on image brightness">
                    <input type="checkbox" name="hero_title_dark" {{ if .Content.HeroTitleDark }}checked{{ end }}>
                    <span class="switch-toggle">
                        <span class="switch-option light">Light</span>
                        <span class="switch-option dark">Dark</span>
                    </span>
                </label>
            </div>
            <div id="header-image-container" class="header-image-container">
                {{ if .HeaderImage }}
                <img src="/ssg/workspace/{{ .Site.Slug }}/images/{{ .HeaderImage.FilePath }}" alt="{{ .HeaderImage.AltText }}">
                <button type="button" class="delete-btn" onclick="removeHeaderImage()" title="Remove header image">&times;</button>
                <div class="overlay">
                    <span class="overlay-alt">{{ if .HeaderImage.AltText }}{{ .HeaderImage.AltText }}{{ else }}No alt text{{ end }}</span>
                    {{ if .HeaderImage.Title }}<span class="overlay-title">{{ .HeaderImage.Title }}</span>{{ end }}
                </div>
                {{ else }}
                <div class="header-image-placeholder" onclick="openImageModal('header')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Click to add header image</span>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Split Pane Editor -->
        <div class="form-group">
            <label>Content (Markdown)</label>
            <div class="editor-toolbar">
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="Italic"><i>I</i></button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt;</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="Link">Link</button>
                    <button type="button" class="toolbar-btn" onclick="insertMarkdown('![alt](', ')')" title="Image">Img</button>
                </div>
                <div class="editor-toolbar-group">
                    <button type="button" class="toolbar-btn" id="proofread-btn" onclick="proofreadText()" title="Proofread text">Proofread</button>
                    <button type="button" class="toolbar-btn" onclick="openMetaModal()" title="SEO & Settings">Meta</button>
                    <button type="button" class="toolbar-btn" onclick="toggleZenMode()" title="Zen Mode (Alt+Z)">Zen</button>
                </div>
            </div>
            <div id="editor-wrapper" class="editor-container">
                <div class="editor-pane">
                    <textarea id="body" name="body" class="editor-textarea">{{ .Content.Body }}</textarea>
                </div>
                <div class="editor-splitter" id="splitter"></div>
                <div class="editor-pane editor-pane-preview">
                    <div id="preview" class="editor-preview prose"></div>
                </div>
            </div>
        </div>

        <!-- Content Images Gallery -->
        <div class="form-group">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <label style="margin-bottom: 0;">Content Images <small>(click to insert at cursor)</small></label>
                <button type="button" class="btn btn-secondary btn-sm" onclick="openImageModal('content')">Upload Image</button>
            </div>
            <div id="content-images" class="image-gallery">
                {{ range .ContentImages }}
                <div class="gallery-image" onclick="insertImageAtCursor('{{ .FilePath }}', '{{ .AltText }}')" title="{{ if .AltText }}{{ .AltText }}{{ end }}{{ if .Title }} - {{ .Title }}{{ end }}">
                    <img src="/ssg/workspace/{{ $.Site.Slug }}/images/{{ .FilePath }}" alt="{{ .AltText }}">
                    <button type="button" class="delete-btn" onclick="event.stopPropagation(); deleteContentImage('{{ .ContentImageID }}')" title="Delete">&times;</button>
                    <div class="overlay">
                        <span class="overlay-alt">{{ if .AltText }}{{ .AltText }}{{ else }}No alt text{{ end }}</span>
                        {{ if .Title }}<span class="overlay-title">{{ .Title }}</span>{{ end }}
                    </div>
                </div>
                {{ else }}
                <p class="empty-state">No images yet</p>
                {{ end }}
            </div>
        </div>

        <!-- Metadata (collapsible) -->
        <details class="form-details">
            <summary>Section, Kind, Contributor & Summary</summary>
            <div class="form-row">
                <div class="form-group">
                    <label for="section_id">Section</label>
                    <select id="section_id" name="section_id">
                        {{ range .Sections }}
                        <option value="{{ .ID }}" {{ if eq .ID $.Content.SectionID }}selected{{ end }}>{{ .Name }}</option>
                        {{ end }}
                    </select>
                </div>

                <div class="form-group">
                    <label for="kind">Kind</label>
                    <select id="kind" name="kind" onchange="toggleSeriesFields()">
                        <option value="page" {{ if eq .Content.Kind "page" }}selected{{ end }}>Page</option>
                        <option value="article" {{ if or (eq .Content.Kind "article") (eq .Content.Kind "blog") }}selected{{ end }}>Article</option>
                        <option value="series" {{ if eq .Content.Kind "series" }}selected{{ end }}>Series</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contributor_id">Contributor</label>
                    <select id="contributor_id" name="contributor_id">
                        <option value="">— None —</option>
                        {{ range .Contributors }}
                        <option value="{{ .ID }}" {{ if and $.Content.ContributorID (eq .ID (deref $.Content.ContributorID)) }}selected{{ end }}>{{ .FullName }} (@{{ .Handle }})</option>
                        {{ end }}
                    </select>
                </div>
            </div>

            <div id="series-fields" class="form-row" style="display: none;">
                <div class="form-group">
                    <label for="series">Series Name</label>
                    <input type="text" id="series" name="series" value="{{ .Content.Series }}">
                </div>

                <div class="form-group">
                    <label for="series_order">Series Order</label>
                    <input type="number" id="series_order" name="series_order" value="{{ .Content.SeriesOrder }}" min="0">
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" name="summary" rows="2">{{ .Content.Summary }}</textarea>
            </div>
        </details>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">Tags</label>
            <input type="text" id="tags" name="tags" placeholder="Add tags...">
            <input type="hidden" id="tags-whitelist" value='[{{ range $i, $t := .Tags }}{{ if $i }},{{ end }}{"value":"{{ $t.Name }}","id":"{{ $t.ID }}"}{{ end }}]'>
            <input type="hidden" id="tags-initial" value='[{{ range $i, $t := .Content.Tags }}{{ if $i }},{{ end }}{"value":"{{ $t.Name }}","id":"{{ $t.ID }}"}{{ end }}]'>
        </div>

        <!-- Publishing Options -->
        <div class="form-row">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="draft" {{ if .Content.Draft }}checked{{ end }}> Draft
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="featured" {{ if .Content.Featured }}checked{{ end }}> Featured
                </label>
            </div>

            <div class="form-group">
                <label for="published_at">Publish Date</label>
                <input type="datetime-local" id="published_at" name="published_at" {{ if .Content.PublishedAt }}value="{{ .Content.PublishedAt.Format "2006-01-02T15:04" }}"{{ end }}>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-primary"
                    hx-post="/ssg/autosave-content"
                    hx-include="#content-form"
                    hx-target="#save-status"
                    hx-swap="outerHTML">Save</button>
        </div>
    </form>
</div>

<!-- Floating buttons for Zen Mode -->
<div id="floating-buttons" class="floating-buttons hidden">
    <button type="button" class="floating-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (Alt+D)">Dark</button>
    <button type="button" class="floating-btn" onclick="toggleZenMode()" title="Exit Zen Mode (Alt+Z)">Exit</button>
</div>

<!-- Image Upload Modal -->
<div id="image-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button type="button" class="modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <form id="image-upload-form" enctype="multipart/form-data">
            <input type="hidden" id="image-purpose" name="purpose" value="content">
            <div class="form-group">
                <label for="image-file">Image File</label>
                <div class="file-input-wrapper">
                    <button type="button" class="btn btn-secondary">Choose File</button>
                    <input type="file" id="image-file" name="file" accept="image/*" required>
                </div>
                <small id="file-name-display" style="display: block; margin-top: 0.5rem; color: var(--stone-beige);"></small>
            </div>
            <div class="form-group">
                <label for="image-alt">Alt Text</label>
                <input type="text" id="image-alt" name="alt_text" placeholder="Describe the image">
            </div>
            <div class="form-group">
                <label for="image-title">Title (optional)</label>
                <input type="text" id="image-title" name="title">
            </div>
            <div class="form-group">
                <label for="image-attribution">Attribution</label>
                <input type="text" id="image-attribution" name="attribution" placeholder="Photo by John Doe">
            </div>
            <div class="form-group">
                <label for="image-attribution-url">Attribution URL</label>
                <input type="url" id="image-attribution-url" name="attribution_url" placeholder="https://...">
            </div>
            <div id="upload-progress" class="upload-progress hidden">
                <div id="upload-progress-bar" class="upload-progress-bar" style="width: 0%"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Meta/SEO Modal -->
<div id="meta-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>SEO & Settings</h2>
            <button type="button" class="modal-close" onclick="closeMetaModal()">&times;</button>
        </div>
        <form id="meta-form">
            <input type="hidden" name="content_id" value="{{ .Content.ID }}">

            <h3 style="margin-top: 0; font-size: 1rem;">SEO</h3>
            <div class="form-group">
                <label for="meta-description">Meta Description</label>
                <textarea id="meta-description" name="description" rows="2" placeholder="Brief description for search engines">{{ if .Meta }}{{ .Meta.Description }}{{ end }}</textarea>
            </div>
            <div class="form-group">
                <label for="meta-keywords">Keywords</label>
                <input type="text" id="meta-keywords" name="keywords" placeholder="keyword1, keyword2, keyword3" value="{{ if .Meta }}{{ .Meta.Keywords }}{{ end }}">
            </div>
            <div class="form-group">
                <label for="meta-robots">Robots</label>
                <select id="meta-robots" name="robots">
                    <option value="" {{ if not .Meta }}selected{{ else if eq .Meta.Robots "" }}selected{{ end }}>Default (index, follow)</option>
                    <option value="noindex" {{ if .Meta }}{{ if eq .Meta.Robots "noindex" }}selected{{ end }}{{ end }}>No Index</option>
                    <option value="nofollow" {{ if .Meta }}{{ if eq .Meta.Robots "nofollow" }}selected{{ end }}{{ end }}>No Follow</option>
                    <option value="noindex, nofollow" {{ if .Meta }}{{ if eq .Meta.Robots "noindex, nofollow" }}selected{{ end }}{{ end }}>No Index, No Follow</option>
                </select>
            </div>
            <div class="form-group">
                <label for="meta-canonical">Canonical URL</label>
                <input type="url" id="meta-canonical" name="canonical_url" placeholder="https://..." value="{{ if .Meta }}{{ .Meta.CanonicalURL }}{{ end }}">
            </div>

            <h3 style="font-size: 1rem;">Display Settings</h3>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="table_of_contents" {{ if .Meta }}{{ if .Meta.TableOfContents }}checked{{ end }}{{ end }}> Show Table of Contents
                </label>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="share" {{ if .Meta }}{{ if .Meta.Share }}checked{{ end }}{{ end }}> Show Share Buttons
                </label>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="comments" {{ if .Meta }}{{ if .Meta.Comments }}checked{{ end }}{{ end }}> Enable Comments
                </label>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMetaModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script src="/static/js/vendor/htmx.min.js"></script>
<script src="/static/js/vendor/marked.min.js"></script>
<script src="/static/js/vendor/tagify.min.js"></script>
<script>
// Configuration
const siteId = '{{ .Site.ID }}';
const contentId = '{{ .Content.ID }}';
const siteSlug = '{{ .Site.Slug }}';

// Elements
const bodyTextarea = document.getElementById('body');
const preview = document.getElementById('preview');
const editorWrapper = document.getElementById('editor-wrapper');
const splitter = document.getElementById('splitter');
const previewPane = document.querySelector('.editor-pane-preview');
const floatingButtons = document.getElementById('floating-buttons');

// Initialize marked
marked.setOptions({
    breaks: true,
    gfm: true
});

// Update preview on input
function updatePreview() {
    preview.innerHTML = marked.parse(bodyTextarea.value || '');
}

bodyTextarea.addEventListener('input', updatePreview);
updatePreview(); // Initial render

// Toggle series fields based on content kind
function toggleSeriesFields() {
    const kind = document.getElementById('kind').value;
    const seriesFields = document.getElementById('series-fields');
    if (kind === 'series') {
        seriesFields.style.display = '';
    } else {
        seriesFields.style.display = 'none';
    }
}
toggleSeriesFields(); // Initial state

// Splitter drag functionality
let isDragging = false;
let startX, startLeftWidth;

splitter.addEventListener('mousedown', (e) => {
    isDragging = true;
    startX = e.clientX;
    const leftPane = splitter.previousElementSibling;
    startLeftWidth = leftPane.offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const leftPane = splitter.previousElementSibling;
    const rightPane = splitter.nextElementSibling;
    const containerWidth = editorWrapper.offsetWidth;
    const newLeftWidth = startLeftWidth + (e.clientX - startX);
    const minWidth = 200;
    const maxWidth = containerWidth - minWidth - splitter.offsetWidth;

    if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
        leftPane.style.flex = 'none';
        leftPane.style.width = newLeftWidth + 'px';
        rightPane.style.flex = '1';
    }
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});

// Toolbar markdown insertion
function insertMarkdown(before, after) {
    const start = bodyTextarea.selectionStart;
    const end = bodyTextarea.selectionEnd;
    const text = bodyTextarea.value;
    const selected = text.substring(start, end);

    bodyTextarea.value = text.substring(0, start) + before + selected + after + text.substring(end);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = start + before.length;
    bodyTextarea.selectionEnd = start + before.length + selected.length;
    updatePreview();
}

// Insert image at cursor
function insertImageAtCursor(filePath, altText) {
    const imgMarkdown = `![${altText || 'image'}](/ssg/workspace/${siteSlug}/images/${filePath})`;
    const start = bodyTextarea.selectionStart;
    const text = bodyTextarea.value;

    bodyTextarea.value = text.substring(0, start) + imgMarkdown + text.substring(start);
    bodyTextarea.focus();
    bodyTextarea.selectionStart = bodyTextarea.selectionEnd = start + imgMarkdown.length;
    updatePreview();
}

// Zen Mode
function toggleZenMode() {
    const isZen = document.body.classList.toggle('zen-mode-active');
    floatingButtons.classList.toggle('hidden');
    // Hide/show preview pane and splitter directly
    splitter.style.display = isZen ? 'none' : '';
    previewPane.style.display = isZen ? 'none' : '';
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    console.log('Dark mode toggled, classes:', document.body.className);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    if (e.altKey && key === 'z') {
        e.preventDefault();
        toggleZenMode();
    }
    if (e.altKey && key === 'd' && document.body.classList.contains('zen-mode-active')) {
        e.preventDefault();
        toggleDarkMode();
    }
    if (e.key === 'Escape' && document.body.classList.contains('zen-mode-active')) {
        toggleZenMode();
    }
});

// Image Modal
function openImageModal(purpose) {
    document.getElementById('image-purpose').value = purpose;
    document.getElementById('image-modal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('image-upload-form').reset();
    document.getElementById('upload-progress').classList.add('hidden');
}

// Display selected file name
document.getElementById('image-file').addEventListener('change', function(e) {
    const fileNameDisplay = document.getElementById('file-name-display');
    if (this.files.length > 0) {
        fileNameDisplay.textContent = this.files[0].name;
    } else {
        fileNameDisplay.textContent = '';
    }
});

// Image Upload (placeholder - requires handler implementation)
document.getElementById('image-upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const progressBar = document.getElementById('upload-progress');
    const progressBarInner = document.getElementById('upload-progress-bar');

    progressBar.classList.remove('hidden');
    progressBarInner.style.width = '0%';

    try {
        const response = await fetch(`/ssg/upload-content-image?content_id=${contentId}&site_id=${siteId}`, {
            method: 'POST',
            body: formData
        });

        progressBarInner.style.width = '100%';

        if (response.ok) {
            closeImageModal();
            // Reload page to show new image
            window.location.reload();
        } else {
            alert('Upload failed. Please try again.');
        }
    } catch (err) {
        alert('Upload error: ' + err.message);
    }
});

// Delete content image (placeholder - requires handler implementation)
async function deleteContentImage(imageId) {
    if (!confirm('Delete this image?')) return;

    try {
        const response = await fetch(`/ssg/delete-content-image?id=${imageId}&site_id=${siteId}`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Delete failed. Please try again.');
        }
    } catch (err) {
        alert('Delete error: ' + err.message);
    }
}

// Remove header image (placeholder - requires handler implementation)
async function removeHeaderImage() {
    if (!confirm('Remove header image?')) return;

    try {
        const response = await fetch(`/ssg/remove-header-image?content_id=${contentId}&site_id=${siteId}`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Remove failed. Please try again.');
        }
    } catch (err) {
        alert('Remove error: ' + err.message);
    }
}

// Meta Modal functions
function openMetaModal() {
    document.getElementById('meta-modal').classList.remove('hidden');
}

function closeMetaModal() {
    document.getElementById('meta-modal').classList.add('hidden');
}

// Meta form submission
document.getElementById('meta-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
        const response = await fetch('/ssg/update-meta', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            closeMetaModal();
            // Show brief success feedback
            const btn = document.querySelector('.toolbar-btn[onclick="openMetaModal()"]');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = 'Saved!';
                setTimeout(() => btn.textContent = originalText, 1500);
            }
        } else {
            alert('Failed to save meta settings. Please try again.');
        }
    } catch (err) {
        alert('Error saving meta: ' + err.message);
    }
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMetaModal();
        closeImageModal();
    }
});

// Close modal on overlay click
document.getElementById('meta-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMetaModal();
    }
});

// Tagify initialization
(function() {
    const input = document.getElementById('tags');
    if (!input) return;

    const whitelist = JSON.parse(document.getElementById('tags-whitelist').value || '[]');
    const initialTags = JSON.parse(document.getElementById('tags-initial').value || '[]');

    const tagify = new Tagify(input, {
        whitelist: whitelist,
        enforceWhitelist: false,
        dropdown: {
            maxItems: 20,
            enabled: 0,
            closeOnSelect: false
        },
        originalInputValueFormat: valuesArr => valuesArr.map(item => JSON.stringify({value: item.value, id: item.id || ''})).join(',')
    });

    // Load initial tags
    if (initialTags.length > 0) {
        tagify.addTags(initialTags);
    }
})();

// Autosave time indicator
(function() {
    let lastSavedAt = null;

    function updateSaveTime() {
        if (!lastSavedAt) return;
        const seconds = Math.floor((Date.now() / 1000) - lastSavedAt);
        const saveText = document.getElementById('save-text');
        if (saveText) {
            if (seconds < 5) {
                saveText.textContent = 'Saved just now';
            } else if (seconds < 60) {
                saveText.textContent = `Saved ${seconds}s ago`;
            } else {
                const minutes = Math.floor(seconds / 60);
                saveText.textContent = `Saved ${minutes}m ago`;
            }
        }
    }

    // Update timestamp when HTMX swaps content
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target.id === 'save-status') {
            const status = document.getElementById('save-status');
            if (status && status.dataset.savedAt) {
                lastSavedAt = parseInt(status.dataset.savedAt);
            }
        }
    });

    // Update display every second
    setInterval(updateSaveTime, 1000);
})();

// Proofread functionality
let proofreadState = {
    active: false,
    originalText: '',
    corrections: [],
    selectedText: '',
    correctedText: ''
};

async function proofreadText() {
    const btn = document.getElementById('proofread-btn');

    // Get selected text or entire body
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    const textToProofread = selectedText || bodyTextarea.value;

    if (!textToProofread) {
        alert('No text to proofread');
        return;
    }

    // Save state
    proofreadState.originalText = bodyTextarea.value;
    proofreadState.selectedText = selectedText;
    proofreadState.active = true;

    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Proofreading...';
    preview.innerHTML = '<div class="proofread-loading"><p>Proofreading text...</p></div>';

    try {
        const response = await fetch(`/ssg/proofread-content?site_id=${siteId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: textToProofread })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Proofread failed');
        }

        const result = await response.json();
        proofreadState.corrections = result.corrections || [];

        if (result.result.mode === 'none') {
            showProofreadResult(null, 'No corrections needed.');
        } else {
            showProofreadResult(result.result.text, result.summary);
        }
    } catch (err) {
        preview.innerHTML = `<div class="proofread-error"><p>Error: ${err.message}</p></div>`;
        resetProofreadUI();
    }
}

function showProofreadResult(correctedText, summary) {
    const btn = document.getElementById('proofread-btn');
    btn.disabled = false;
    btn.textContent = 'Proofread';

    if (!correctedText) {
        preview.innerHTML = `
            <div class="proofread-result no-changes">
                <p>${escapeHtml(summary)}</p>
                <div class="proofread-actions">
                    <button type="button" class="btn-secondary" onclick="cancelProofread()">OK</button>
                </div>
            </div>
        `;
        return;
    }

    proofreadState.correctedText = correctedText;

    preview.innerHTML = `
        <div class="proofread-result">
            <div class="proofread-summary">${escapeHtml(summary)}</div>
            <div class="proofread-text">${escapeHtml(correctedText)}</div>
            <div class="proofread-actions">
                <button type="button" class="btn-apply" onclick="applyProofread()">Apply</button>
                <button type="button" class="btn-secondary" onclick="showCorrections()">Changes (${proofreadState.corrections.length})</button>
                <button type="button" class="btn-secondary" onclick="cancelProofread()">Discard</button>
            </div>
        </div>
    `;
}

function applyProofread() {
    const correctedText = proofreadState.correctedText;

    if (proofreadState.selectedText) {
        // Replace only the selection
        const start = bodyTextarea.value.indexOf(proofreadState.selectedText);
        if (start !== -1) {
            bodyTextarea.value = bodyTextarea.value.substring(0, start) + correctedText + bodyTextarea.value.substring(start + proofreadState.selectedText.length);
        }
    } else {
        // Replace entire content
        bodyTextarea.value = correctedText;
    }

    updatePreview();
    resetProofreadState();
}

function cancelProofread() {
    updatePreview();
    resetProofreadState();
}

function resetProofreadState() {
    proofreadState.active = false;
    proofreadState.originalText = '';
    proofreadState.selectedText = '';
    proofreadState.corrections = [];
    proofreadState.correctedText = '';
}

function resetProofreadUI() {
    const btn = document.getElementById('proofread-btn');
    btn.disabled = false;
    btn.textContent = 'Proofread';
}

function showCorrections() {
    const corrections = proofreadState.corrections;
    if (!corrections.length) {
        alert('No corrections to show');
        return;
    }

    const grouped = {
        grammar: corrections.filter(c => c.type === 'grammar'),
        style: corrections.filter(c => c.type === 'style'),
        echo: corrections.filter(c => c.type === 'echo'),
        overuse: corrections.filter(c => c.type === 'overuse')
    };

    let html = `<div class="corrections-modal">
        <div class="corrections-modal-content">
            <div class="corrections-modal-header">
                <h3>Corrections</h3>
                <button type="button" class="corrections-modal-close" onclick="this.closest('.corrections-modal').remove()">&times;</button>
            </div>
            <div class="corrections-modal-body">`;

    let correctionIndex = 0;
    for (const [type, items] of Object.entries(grouped)) {
        if (items.length === 0) continue;
        html += `<div class="correction-group"><h4>${type.charAt(0).toUpperCase() + type.slice(1)} (${items.length})</h4>`;
        for (const c of items) {
            html += `<div class="correction-item" data-index="${correctionIndex}" data-original="${escapeHtml(c.original)}" data-replacement="${escapeHtml(c.replacement || '')}">`;
            html += `<div class="correction-content">`;
            if (c.replacement) {
                html += `<div class="correction-change"><span class="correction-original">${escapeHtml(c.original)}</span><span class="correction-arrow"> → </span><span class="correction-replacement">${escapeHtml(c.replacement)}</span></div>`;
            } else {
                html += `<div class="correction-change"><span class="correction-original">${escapeHtml(c.original)}</span></div>`;
            }
            html += `<div class="correction-explanation">${escapeHtml(c.explanation)}</div>`;
            html += `</div>`;
            if (c.replacement) {
                html += `<div class="correction-actions"><button type="button" class="correction-apply-btn" onclick="applySingleCorrection(this)">Apply</button></div>`;
            }
            html += `</div>`;
            correctionIndex++;
        }
        html += '</div>';
    }

    html += '</div></div></div>';

    document.body.insertAdjacentHTML('beforeend', html);
    refreshCorrectionsState();
}

function applySingleCorrection(btn) {
    const item = btn.closest('.correction-item');
    const original = item.dataset.original;
    const replacement = item.dataset.replacement;

    const textarea = document.getElementById('body');
    if (!textarea.value.includes(original)) {
        alert('This correction is no longer applicable - text not found');
        return;
    }

    textarea.value = textarea.value.replace(original, replacement);
    item.classList.add('applied');
    btn.disabled = true;
    btn.textContent = 'Applied';

    updatePreview();
    refreshCorrectionsState();
}

function refreshCorrectionsState() {
    const textarea = document.getElementById('body');
    const text = textarea.value;

    document.querySelectorAll('.correction-item:not(.applied)').forEach(item => {
        const original = item.dataset.original;
        const btn = item.querySelector('.correction-apply-btn');
        if (!btn) return;

        const isValid = text.includes(original);
        item.classList.toggle('invalid', !isValid);
        btn.disabled = !isValid;
        if (!isValid && btn.textContent === 'Apply') {
            btn.textContent = 'N/A';
        }
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{{ end }}
