{{ define "content" }}
<div class="card">
    <p class="breadcrumb"><a href="/ssg/get-site?id={{ .Site.ID }}">{{ .Site.Name }}</a></p>
    <div class="card-header">
        <h1>Import</h1>
        <span class="text-muted">Import Markdown files from <code>{{ .ImportPath }}</code></span>
    </div>

    {{ if .Error }}
    <div class="alert alert-danger">{{ .Error }}</div>
    {{ end }}
    {{ if .Success }}
    <div class="alert alert-success">{{ .Success }}</div>
    {{ end }}

    {{ if .ImportRows }}
    <form method="POST" action="/ssg/import/do?site_id={{ .Site.ID }}" id="import-form">
        <div class="form-group">
            <label for="section_id">Target Section</label>
            <select name="section_id" id="section_id" required>
                <option value="">Select a section...</option>
                {{ range .Sections }}
                <option value="{{ .ID }}">{{ .Name }} ({{ .Path }})</option>
                {{ end }}
            </select>
        </div>

        <div class="filter-tabs">
            <button type="button" class="filter-btn active" data-filter="all">All</button>
            <button type="button" class="filter-btn" data-filter="new">New</button>
            <button type="button" class="filter-btn" data-filter="updated">Updated</button>
            <button type="button" class="filter-btn" data-filter="conflict">Conflicts</button>
        </div>

        <table id="import-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>File</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{ range .ImportRows }}
                <tr class="import-row {{ if eq .Status "synced" }}synced-row{{ end }} {{ if eq .Status "conflict" }}conflict-row{{ end }}" data-status="{{ .Status }}">
                    <td>
                        {{ if eq .Status "new" }}
                        <input type="checkbox" name="file_paths[]" value="{{ .File.Path }}">
                        {{ else if eq .Status "updated" }}
                        <input type="checkbox" name="reimport_ids[]" value="{{ .Import.ID }}">
                        {{ else if eq .Status "conflict" }}
                        <input type="checkbox" name="reimport_ids[]" value="{{ .Import.ID }}" data-conflict="true">
                        {{ end }}
                    </td>
                    <td><code>{{ .File.Name }}</code></td>
                    <td>
                        {{ if .Import }}
                            {{ if .Import.ContentID }}
                            <a href="/ssg/get-content?id={{ .Import.ContentID }}&site_id={{ $.Site.ID }}">{{ .Import.ContentHeading }}</a>
                            {{ else }}
                            {{ .File.Title }}
                            {{ end }}
                        {{ else }}
                        {{ .File.Title }}
                        {{ end }}
                    </td>
                    <td>
                        {{ if eq .Status "new" }}
                        <span class="badge badge-info">New</span>
                        {{ else if eq .Status "synced" }}
                        <span class="badge badge-muted">Synced</span>
                        {{ else if eq .Status "updated" }}
                        <span class="badge badge-warning">Reimport</span>
                        {{ else if eq .Status "conflict" }}
                        <span class="badge badge-danger">Conflict</span>
                        {{ else if eq .Status "missing" }}
                        <span class="badge badge-secondary">Missing</span>
                        {{ end }}
                    </td>
                    <td>{{ .File.Mtime.Format "2006-01-02 15:04" }}</td>
                    <td>
                        {{ if eq .Status "new" }}
                        <a href="/ssg/import/preview?site_id={{ $.Site.ID }}&path={{ .File.Path }}" class="btn btn-sm">Preview</a>
                        {{ else if .Import }}
                            {{ if .Import.ContentID }}
                            <a href="/ssg/get-content?id={{ .Import.ContentID }}&site_id={{ $.Site.ID }}" class="btn btn-sm">View</a>
                            {{ end }}
                        {{ end }}
                    </td>
                </tr>
                {{ end }}
            </tbody>
        </table>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="import-btn">Import Selected</button>
        </div>
    </form>
    {{ else }}
    <p class="empty-state">No files found in <code>{{ .ImportPath }}</code></p>
    {{ end }}
</div>

<script>
function toggleAll(checkbox) {
    var checkboxes = document.querySelectorAll('#import-table tbody input[type="checkbox"]:not([disabled])');
    checkboxes.forEach(function(cb) {
        var row = cb.closest('tr');
        if (row.style.display !== 'none') {
            cb.checked = checkbox.checked;
        }
    });
    updateButtonLabel();
}

function updateButtonLabel() {
    var hasConflict = false;
    var checkboxes = document.querySelectorAll('#import-table tbody input[type="checkbox"]:checked');
    checkboxes.forEach(function(cb) {
        if (cb.dataset.conflict === 'true') {
            hasConflict = true;
        }
    });

    var btn = document.getElementById('import-btn');
    if (hasConflict) {
        btn.textContent = 'Import Selected (includes conflicts)';
        btn.classList.add('btn-warning');
    } else {
        btn.textContent = 'Import Selected';
        btn.classList.remove('btn-warning');
    }
}

document.querySelectorAll('#import-table tbody input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', updateButtonLabel);
});

document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var filter = this.dataset.filter;

        document.querySelectorAll('.filter-btn').forEach(function(b) {
            b.classList.remove('active');
        });
        this.classList.add('active');

        document.querySelectorAll('#import-table tbody tr').forEach(function(row) {
            var status = row.dataset.status;
            if (filter === 'all') {
                row.style.display = '';
            } else if (filter === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Uncheck select-all when filtering
        document.getElementById('select-all').checked = false;
    });
});
</script>

<style>
.filter-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}
.filter-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid var(--border-color, #ddd);
    background: var(--bg-secondary, #f5f5f5);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.15s ease;
}
.filter-btn:hover {
    background: var(--bg-hover, #e9e9e9);
}
.filter-btn.active {
    background: var(--primary-color, #4a90a4);
    color: white;
    border-color: var(--primary-color, #4a90a4);
}

/* Synced rows are grayed out */
.synced-row {
    opacity: 0.5;
}
.synced-row td {
    color: var(--text-muted, #888);
}

/* Conflict rows highlight */
.conflict-row {
    background-color: rgba(220, 53, 69, 0.05);
}

/* Badge styles */
.badge-info {
    background-color: #17a2b8;
    color: white;
}
.badge-muted {
    background-color: #6c757d;
    color: white;
}
.badge-secondary {
    background-color: #adb5bd;
    color: #333;
}
</style>
{{ end }}
