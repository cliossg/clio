{{ define "content" }}
<div class="card">
    <p class="breadcrumb"><a href="/ssg/list-sections?site_id={{ .Site.ID }}">‚Üê Sections</a></p>
    <div class="card-header">
        <h1>Edit Section</h1>
    </div>

    <form method="POST" action="/ssg/update-section">
        <input type="hidden" name="site_id" value="{{ .Site.ID }}">
        <input type="hidden" name="id" value="{{ .Section.ID }}">

        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" value="{{ .Section.Name }}" required>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="2">{{ .Section.Description }}</textarea>
        </div>

        <div class="form-group">
            <label for="path">URL Path</label>
            <input type="text" id="path" name="path" value="{{ .Section.Path }}">
            <small>The URL path for this section. Leave empty for root.</small>
        </div>

        <div class="form-group">
            <label for="layout_id">Layout</label>
            <select id="layout_id" name="layout_id">
                <option value="">-- Default --</option>
                {{ range .Layouts }}
                <option value="{{ .ID }}" {{ if eq .ID $.Section.LayoutID }}selected{{ end }}>{{ .Name }}</option>
                {{ end }}
            </select>
            <small>Uses site default layout if set, otherwise embedded template</small>
        </div>

        <!-- Header Image Section -->
        <div class="form-group">
            <div class="form-group-header">
                <label>Section Header Image</label>
                <label class="switch-label discrete" title="Select based on image brightness">
                    <input type="checkbox" name="hero_title_dark" {{ if .Section.HeroTitleDark }}checked{{ end }}>
                    <span class="switch-toggle">
                        <span class="switch-option light">Light</span>
                        <span class="switch-option dark">Dark</span>
                    </span>
                </label>
            </div>
            <div id="header-image-container" class="header-image-container">
                {{ if .SectionHeader }}
                <img src="/ssg/workspace/{{ .Site.Slug }}/images/{{ .SectionHeader.FilePath }}" alt="{{ .SectionHeader.AltText }}">
                <button type="button" class="delete-btn" onclick="deleteSectionImage('{{ .SectionHeader.SectionImageID }}')" title="Remove header image">&times;</button>
                <div class="overlay">
                    <span class="overlay-alt">{{ if .SectionHeader.AltText }}{{ .SectionHeader.AltText }}{{ else }}No alt text{{ end }}</span>
                    {{ if .SectionHeader.Title }}<span class="overlay-title">{{ .SectionHeader.Title }}</span>{{ end }}
                </div>
                {{ else }}
                <div class="header-image-placeholder" onclick="openImageModal('header')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Click to add header image</span>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Section Images Gallery -->
        <div class="form-group">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5rem;">
                <label style="margin-bottom: 0;">Section Images</label>
                <button type="button" class="btn btn-secondary btn-sm" onclick="openImageModal('content')">Upload Image</button>
            </div>
            <div id="section-images" class="image-gallery">
                {{ range .SectionImages }}
                <div class="gallery-image" title="{{ if .AltText }}{{ .AltText }}{{ end }}{{ if .Title }} - {{ .Title }}{{ end }}">
                    <img src="/ssg/workspace/{{ $.Site.Slug }}/images/{{ .FilePath }}" alt="{{ .AltText }}">
                    <button type="button" class="delete-btn" onclick="event.stopPropagation(); deleteSectionImage('{{ .SectionImageID }}')" title="Delete">&times;</button>
                    <div class="overlay">
                        <span class="overlay-alt">{{ if .AltText }}{{ .AltText }}{{ else }}No alt text{{ end }}</span>
                        {{ if .Title }}<span class="overlay-title">{{ .Title }}</span>{{ end }}
                    </div>
                </div>
                {{ else }}
                <p class="empty-state">No images yet</p>
                {{ end }}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Update Section</button>
            <a href="/ssg/list-sections?site_id={{ .Site.ID }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Image Upload Modal -->
<div id="image-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button type="button" class="modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <form id="image-upload-form" enctype="multipart/form-data">
            <input type="hidden" id="image-purpose" name="purpose" value="content">
            <div class="form-group">
                <label for="image-file">Image File</label>
                <div class="file-input-wrapper">
                    <button type="button" class="btn btn-secondary">Choose File</button>
                    <input type="file" id="image-file" name="file" accept="image/*" required>
                </div>
                <small id="file-name-display" style="display: block; margin-top: 0.5rem; color: var(--stone-beige);"></small>
            </div>
            <div class="form-group">
                <label for="image-alt">Alt Text</label>
                <input type="text" id="image-alt" name="alt_text" placeholder="Describe the image">
            </div>
            <div class="form-group">
                <label for="image-title">Title (optional)</label>
                <input type="text" id="image-title" name="title">
            </div>
            <div class="form-group">
                <label for="image-attribution">Attribution</label>
                <input type="text" id="image-attribution" name="attribution" placeholder="Photo by John Doe">
            </div>
            <div class="form-group">
                <label for="image-attribution-url">Attribution URL</label>
                <input type="url" id="image-attribution-url" name="attribution_url" placeholder="https://...">
            </div>
            <div id="upload-progress" class="upload-progress hidden">
                <div id="upload-progress-bar" class="upload-progress-bar" style="width: 0%"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<script>
const siteId = '{{ .Site.ID }}';
const sectionId = '{{ .Section.ID }}';
const siteSlug = '{{ .Site.Slug }}';

function openImageModal(purpose) {
    document.getElementById('image-purpose').value = purpose;
    document.getElementById('image-modal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('image-modal').classList.add('hidden');
    document.getElementById('image-upload-form').reset();
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('file-name-display').textContent = '';
}

document.getElementById('image-file').addEventListener('change', function(e) {
    const fileNameDisplay = document.getElementById('file-name-display');
    if (this.files.length > 0) {
        fileNameDisplay.textContent = this.files[0].name;
    } else {
        fileNameDisplay.textContent = '';
    }
});

document.getElementById('image-upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const progressBar = document.getElementById('upload-progress');
    const progressBarInner = document.getElementById('upload-progress-bar');

    progressBar.classList.remove('hidden');
    progressBarInner.style.width = '0%';

    try {
        const response = await fetch(`/ssg/upload-section-image?section_id=${sectionId}&site_id=${siteId}`, {
            method: 'POST',
            body: formData
        });

        progressBarInner.style.width = '100%';

        if (response.ok) {
            closeImageModal();
            window.location.reload();
        } else {
            alert('Upload failed. Please try again.');
        }
    } catch (err) {
        alert('Upload error: ' + err.message);
    }
});

async function deleteSectionImage(imageId) {
    if (!confirm('Delete this image?')) return;

    try {
        const response = await fetch(`/ssg/delete-section-image?id=${imageId}&site_id=${siteId}`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Delete failed. Please try again.');
        }
    } catch (err) {
        alert('Delete error: ' + err.message);
    }
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

document.getElementById('image-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});
</script>
{{ end }}
